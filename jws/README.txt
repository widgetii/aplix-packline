========================================================================

                    PackLine Java Seb Start (JWS)

========================================================================

Данный проект представляет собой программу-установщик (инсталлятор) для PackLine. 
Инсталлятор работает по технологии Java Web Start. При этом процесс установки 
программы выглядит следующим образом:

1) На корпоративном веб-сервере содержится дистрибутив программы, с него идет 
установка программы на клиентские машины. Кроме собственно дистрибутива, сервер 
также может содержать базу обновлений, которые должны быть распределены по папкам, 
имена которых совпадают с MAC адресами машин. 

2) Для установки программы на клиентской машине надо зайти через браузер на 
корпоративный веб-сервер, скачать и установить сертификат Aplix, затем перейти по 
ссылке, чтобы установить программу. На машине должна быть уже установлена Java 7 
с поддержкой Java FX 2.2. При этом в Java запустится специальный загрузчик, который 
выкачает дистрибутив программы, развернет его в локальной файловой системе, создаст 
ярлык запуска на рабочем столе. Во время установки, загрузчик определит MAC адрес 
машины и попробует найти дополнительные обновления для нее - если таковые найдутся, 
они также будут скопированы, после чего запуститься главная программа PackLine.

3) После установки на рабочем столе появится ярлык запуска программы. Можно 
запускать программу как и раньше, - путем вызова .bat или .sh файла, но тогда не 
будет происходить обновление программы. Если запускать через ярлык на рабочем столе, 
то будет запускаться загрузчик, который проверяет наличие свежей версии 
дистрибутива программы, наличие дополнительных обновлений, копировать при 
необходимости обновления, а потом запускать PackLine. Программа будет запускаться 
как при действующем корпоративном веб-сервере, так и без него (в последнем случае 
просто ничего обновляться не будет).

Для того, чтобы провести обновление самой программы, на корпоративный веб-сервер 
нужно скопировать новый дистрибутив (packline-distributive-package.jar) и/или 
положить дополнительное обновление в папку, названную по MAC-адресу машины. При 
следующем запуске программы, загрузчик все обновит сам.


НАСТРОЙКА ВЕБ-СЕРВЕРА

В качестве веб-сервера могут выступать либо Apache 2 либо Microsoft IIS 7. При 
использовании других веб-серверов программа будет устанавливаться, но дополнительные 
обновления по MAC-адресу работать не будут.

Определите адрес раздачи дистрибутива, например это будет http://aplix.corp/packline. 
Соответственно в папке, где располагается контент корпоративного сайта, создайте 
подпапку /packline, куда скопируйте содержимое дистрибутива из /jws/target/dist. 
Дистрибутив состоит из следующих файлов:

	packline-distributive-package.jar 	– основной пакет, содержащий архив с 
										  программой;
	packline-installer.jar 				– программа-установщик, запускается менеджером 
										  JWS, когда нужно провести обновления программы;
	packline-launcher.jar 				– программа, осуществляющая проверку 
										  необходимости обновлений и запуск основной 
										  программы PackLine.
	installer.jnlp 						– файл описания программы-установщика, по которому 
										  java определяет, что нужно устанавливать;
	launcher.jnlp 						– файл описания, по которому java определяет, 
										  что нужно запускать;
	aplix.png 							– иконка Aplix для оформления ярлыка на 
										  рабочем столе.

Дополнительные файлы, которые не входят в основной дистрибутив, но используются в 
процессе установки. Для примера их тоже нужно скопировать в подпапку /packline на 
веб-сервере: 

	launcher.html 	– пример веб-страницы, демонстрирующей установку и запуск программы.
	aplix.csr 		– сертификат Aplix, который нужно установить на клиентскую машину 
					  прежде, чем запускать установку программы. Без данного сертификата, 
					  установка программы будет невозможна. В данном примере сертификат 
					  распространяется через сайт программы (ссылка добавлена в 
					  html-страницу), но это не обязательно, его можно перенести любым 
					  другим способом.

Поскольку адрес размещения дистрибутива на сайте может изменяться (в данном примере 
используется http://aplix.corp/packline, но он может быть любым), файлы с расширением 
.jnlp нужно отредактировать. JNLP – это текстовый файл в формате XML, отредактируйте в 
нем параметр codebase, прописав действительный адрес размещения дистрибутива, например 
так codebase=”http://aplix.corp/packline”. Сделать это нужно во всех файлах .jnlp.
При желании можно изменить путь и название файла иконки, например 
<icon href="/images/packline.jpeg" />. Другие поля в файлах JNLP менять нельзя, иначе 
JWS заблокирует установку приложения.

Если вы используете Microsoft-IIS, то в настройках веб-сервера нужно прописать 
дополнительные типы MIME

	.jnlp		application/x-java-jnlp-file
	.csr		application/pkcs10

В Apache2 ничего более настраивать не надо.

После копирования дистрибутива в папку веб-сервера можно попробовать установить программу, 
зайдя на адрес http://aplix.corp/packline/launcher.html. Это лишь пример страницы, она 
может быть написана и оформлена в соответствии с  правилами  корпоративного сайта, 
единственно, что для установки программы, нужно где-то прописать ссылку на файл 
launcher.jnlp.


УСТАНОВКА ПРОГРАММЫ

Java Web Start предъявляет очень жесткие требования к безопасности приложений. 
Распространяемое приложение должно быть обязательно подписано сертификатом, 
подтвержденным доверительным центром сертификации. Данное приложение подписано 
сертификатом вида self-signed, т.е. он подтверждает сам себя. Поэтому сертификат 
(aplix.csr) нужно импортировать в реестр сертификатов дважды – один раз в раздел 
«Trusted Certificates», второй раз в раздел «Signer CA». Сделать это необходимо 
вручную в Java Control Panel в разделе «Security», нажав кнопку 
«Manage Certificates…». Можно обойтись и без установки сертификата – достаточно 
добавить адрес раздачи приложения в раздел «Exception Site List» либо вовсе 
понизить общий уровень безопасности до «Medium», но тогда при каждом запуске 
приложения будет выскакивать запрос на разрешение этого действия. Автоматический 
запуск без всяких запросов возможен только с добавлением сертификата в оба раздела 
«Trusted Certificates» и «Signer CA».

Если вы работаете на Mac OS, то дополнительно нужно разрешить установку приложений 
из других источников, иначе система заблокирует установку приложения JWS. сделать 
это можно в System Preferences в разделе Security & Policy, установив флажок 
«Allow apps from anywhere».

В зависимости от операционной системы, приложение устанавливается в следующие 
места:

	Microsoft Windows: 	C:\Program Files\Aplix\ 
	Linux: 				/opt/Aplix/
	Mac OS: 			/Applications/

В операционной системе Linux программа установщик может не иметь прав на создание 
каталога в папке /opt/. Поэтому перед установкой создайте каталог самостоятельно, 
выполнив следующую команду: sudo mkdir -m 777 /opt/Aplix

Теперь можно зайти на корпоративный сайт (пример http://aplix.corp/packline/launcher.html) 
и запустить установку программы. При этом Java запустит наш загрузчик, который 
выкачает дистрибутив программы, развернет его в локальной файловой системе, 
создаст ярлык запуска на рабочем столе и запустит главную программу PackLine. 

Если Java Web Start блокирует установку приложения или выдает ошибку, значит, 
вы что-то сделали неправильно, - проверьте описанные выше  настройки еще раз 
(возможно, вы забыли отредактировать codebase в JNLP-файлах?).

Если установка прошла успешно, но главная программа так и не запустилась, то 
ошибку следует искать в лог-файле packline-jws.log. Путь к этому файлу определяется 
для java системной переменной "java.io.tmpdir":

	В Windows:	c:\Users\<UserName>\AppData\Local\Temp\
	В Linux:	/tmp


НАСТРОЙКА ОБНОВЛЕНИЙ ПО MAC-АДРЕСУ

Во время запуска программы через ярлык на рабочем столе проверяется не только 
наличие свежей версии дистрибутива программы, но и наличие дополнительных обновлений. 
Эти дополнительные обновления могут быть любыми файлами, необходимыми для работы 
программы PackLine. К примеру, рассмотрим конфигурационный файл packline.xconf, 
который настроен под машину с mac-адресом 10-BF-48-09-53-32.

Дополнительные обновления должны находиться в папке <codebase>/updates/<mac-address>/, 
где <codebase> - адрес, с которого происходила установка программы (его вы прописывали 
в JNLP файлах). Структура каталогов в папке с обновлением будет скопирована 
один-в-один в папку с установленной программой. Т.е. для нашего примера, 
конфигурационный файл, находящийся в 
http://aplix.corp/packline/updates/10-BF-48-09-53-32/packline-v0.9/conf/packline.xconf 
будет скопирован в папку "C:\Program Files\Aplix\packline-v0.9\conf\packline.xconf", 
тем самым заменив исходный файл.

Чтобы размещенные для обновления файлы не копировались каждый раз при запуске программы, 
в папку <codebase>/updates/<mac-address>/ на сервере следует положить текстовый файл 
«version», в котором надо указать версию обновления. Прежде всего, загрузчик считает 
данный файл, сравнит версии и только при наличии расхождений проведет обновление. 
В файле «version» можно записать любой поясняющий текст, главное не забывать изменять 
его при размещении новых обновлений.

В веб-сервере должна быть включена возможность просматривать содержимое каталогов 
посредством HTTP. Убедитесь, что вы можете осуществлять навигацию по папке 
«/packline/updates/...», используя ваш браузер.

Если вы используете Microsoft-IIS, то в настройках веб-сервера нужно прописать 
дополнительные типы MIME

	.xconf		text/xml
	.bat		application/bat
	.*			application/octet-stream

В Apache2 ничего более настраивать не надо.



